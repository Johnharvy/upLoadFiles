<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content= "width=device-width, initial-scale=1.0,minimum-scale=1,maximum-scale=1,user-scalable=1" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <title>生成图片</title>
</head>
<body>
    <!--需要合成图片，因为没法直接读取本地图片，所以将图片放在这里并隐藏-->
    <div style="display:none; width : 360px; height : 640px;">
         <img id="starImg" style="height:100%; width:100%;display : block;" src="./demo.jpg" />
    </div>

    <!--画布-->
    <canvas id="main" height="600" width="900" style="border:1px solid #d3d3d3;">
        
    </canvas>

    <!--输入框，失去焦点后自动执行hechen()-->
    <input type="text" id="desc" onblur="merge()" value="" />
    <!--saveImageInfo()生成照片并显示到另个网页-->
    <button onclick="saveImageInfo()">确认生成</button>

   <!--  <div class = 'code' style = 'display: none'>000000</div> -->


<script>
    //预加载将图片绘制到画布
    $(function(){
          merge()
    });

    function merge(){
     
        //获取画布对象
        var mainCtx = getCanvasContext('main');
        var maxWidth = mainCtx.width;
        var maxHeight = mainCtx.height;
        mainCtx.clearRect(0,0,600,600);


        //获取图片的实际路径
        var starImg = new Image();
        starImg.src = $('#starImg').attr('src');
      
    
        //合成
        starImg.onload=function(){
            //先把图片绘制在这里
            mainCtx.drawImage(starImg,0,0,this.width,this.height);

            //贴上文本
            mainCtx.font = "small-caps bold 3rem STXinwei";
            mainCtx.fillStyle = "#fff";
            mainCtx.fillText($('.desc').val(),50,50);
            
        };

    }
    //通过id获取canvas对象
    function getCanvasContext(id){
        return document.getElementById(id).getContext("2d");
    }

    //将画布生成图片
    function saveImageInfo() {
        var mycanvas = document.getElementById("main");
        var image = mycanvas.toDataURL("image/jpg"); //解析base64格式
        var dimg = new Image()
        dimg.src = image;
        var combinedImg = getBase64Image(dimg)
        var w = window.open('about:blank','image from canvas');
        w.document.write("<img src='" + image + "' alt='from canvas'/>");
    }

     //将 base64格式文件转化成blob对象
    function getBase64Image(img) {
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, img.width, img.height);
        var ext = img.src.substring( img.src.lastIndexOf(".") + 1 ).toLowerCase();
        var dataURL = canvas.toDataURL("image/" + ext);
        
        return {
          dataURL: dataURL,
          type: "image/"+ext
        };

      }
  

</script>
    
</body>
</html>